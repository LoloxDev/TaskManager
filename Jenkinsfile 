pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                git 'https://github.com/LoloxDev/TaskManager.git'
            }
        }
        
        stage('Build') {
            steps {
                sh 'npm install'
            }
        }

        stage('Security Scan') {
            steps {
                // Démarrage de OWASP ZAP pour le scan de sécurité
                sh '/usr/local/bin/zap.sh -daemon -port 8090 -host localhost -config api.disablekey=true'

                // Exécution des tests de sécurité avec OWASP ZAP
                sh '/usr/local/bin/zap-cli --zap-url http://localhost:8090 -p 8090 -d -f baseline-scan.policy -r report.html'

                // Arrêt de OWASP ZAP après le scan
                sh '/usr/local/bin/zap-cli --zap-url http://localhost:8090 -p 8090 shutdown'
            }
        }

        stage('Test') {
            steps {
                // Exécute les tests Node.js (remplacez par votre commande de test)
                sh 'npm test'
            }
        }
    }

    post {
        always {
            // Toujours nettoyer et arrêter OWASP ZAP après le pipeline
            sh '/usr/local/bin/zap-cli --zap-url http://localhost:8090 -p 8090 shutdown'
        }
    }
}
